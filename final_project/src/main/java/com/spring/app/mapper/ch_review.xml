<?xml version="1.0" encoding="UTF-8"?>

<!-- ==== #29. mapper 기본설정 ==== -->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<!-- ==== #29. 루트 엘리먼트 & 네임스페이스 설정(프로젝트 전체내에서 유일해야 한다.) ==== -->
<mapper namespace="ch_review"> 

   <!-- 글목록 -->
   <resultMap type="HashMap" id="reviewList_Map">
   	  <result property="RV_SEQ"           column="RV_SEQ"                 javaType="String" />	
   	  <result property="FK_LODGE_ID"      column="FK_LODGE_ID"            javaType="String" />	
   	  <result property="FK_USERID"        column="FK_USERID"            javaType="String" />	
      <result property="RV_SUBJECT"       column="RV_SUBJECT"             javaType="String" />
      <result property="RV_CONTENT"       column="RV_CONTENT"             javaType="String" />
      <result property="RV_REGDATE"       column="RV_REGDATE"             javaType="String" />
      <result property="RV_GROUPNO"       column="RV_GROUPNO"             javaType="Integer" />
      <result property="RV_ORG_SEQ"       column="RV_ORG_SEQ"             javaType="Integer" />
      <result property="RV_DEPTHNO"       column="RV_DEPTHNO"             javaType="Integer" />
      <result property="livedate"         column="livedate"               javaType="String" />
      <result property="FK_RV_RATING"     column="FK_RV_RATING"           javaType="Integer" />
      <result property="RV_RATING_DESC"   column="RV_RATING_DESC"         javaType="String" />
      <result property="RS_NAME"          column="RS_NAME"                javaType="String" />
      <result property="RS_DATE"          column="RS_DATE"                javaType="String" />     
      <result property="H_LODGENAME"      column="H_LODGENAME"            javaType="String" />     
      
   </resultMap>
<select id="reviewList" parameterType="HashMap" resultMap="reviewList_Map">
        SELECT V.RV_SEQ, V.FK_LODGE_ID, V.FK_RS_SEQ, V.FK_USERID, R.RS_NAME, V.RV_SUBJECT, V.RV_CONTENT, RV_GROUPNO, RV_ORG_SEQ, RV_DEPTHNO
		     , TO_CHAR(V.rv_regdate, 'yyyy"년" mm"월" dd"일"') AS RV_REGDATE, V.RV_STATUS
		     , V.FK_RV_RATING, T.RV_RATING_DESC
		     , (TO_DATE(R.rs_checkoutdate, 'YYYY-MM-DD') - TO_DATE(R.rs_checkindate, 'YYYY-MM-DD'))||'박' AS livedate
		     , TO_CHAR(R.RS_DATE, 'yyyy"년" mm"월"') AS RS_DATE, h.H_LODGENAME
		FROM
		(
		select RV_SEQ,FK_LODGE_ID, FK_RS_SEQ, FK_USERID, RV_SUBJECT, RV_CONTENT, RV_REGDATE, RV_STATUS,  RV_GROUPNO, RV_ORG_SEQ, RV_DEPTHNO, FK_RV_RATING
		from tbl_review
		union all 
		select C_SEQ, FK_LODGE_ID, FK_RS_SEQ, FK_H_USERID, C_SUBJECT, C_CONTENT, C_REGDATE, C_STATUS, C_GROUPNO, C_ORG_SEQ, C_DEPTHNO, FK_C_RATING
		from tbl_comment
		) V
		left join tbl_reservation R ON R.RS_SEQ = V.FK_RS_SEQ
		left join tbl_host H ON H.h_userid = V.fk_userid
		left join tbl_rating T ON T.RV_RATING = V.FK_RV_RATING     
		where RV_STATUS = 1
		start with RV_ORG_SEQ = 0 
		connect by prior RV_SEQ = RV_ORG_SEQ 
		order siblings by RV_GROUPNO desc, RV_SEQ asc
    
</select>
   


</mapper>